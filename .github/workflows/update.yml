name: Update Source

on:
  schedule:
    - cron: '0 * * * *' # Run every hour
  workflow_dispatch: 
    inputs:
      app_data:
        description: 'JSON string of app data to process (Add/Update/Remove)'
        required: false
        type: string
      mode:
        description: 'Operation mode: add, update, remove'
        required: false
        default: 'update'
        type: choice
        options:
          - add
          - update
          - remove
      issue_number:
        description: 'Issue number to close upon completion'
        required: false
        type: string
  push:
    paths:
      - '.github/scripts/**'
      - '.github/workflows/update.yml'
      - '**/apps.json'

permissions:
  contents: write

jobs:
  update-source:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.commit.outputs.has_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'
          cache-dependency-path: '.github/requirements.txt'

      - name: Install dependencies
        run: pip install -r .github/requirements.txt

      - name: Run update script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Running update_source.py..."
          python .github/scripts/update_source.py

      - name: Sync Issue Template
        run: python .github/scripts/sync_issue_template.py

      - name: Commit and push changes
        id: commit
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add .
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git commit -m "Update source.json, app lists, and templates"
            
            # Robust push with retry logic for concurrency
            MAX_RETRIES=5
            RETRY_COUNT=0
            until git pull --rebase && git push; do
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
                echo "Failed to push after $MAX_RETRIES attempts."
                exit 1
              fi
              echo "Push failed, retrying in $((RETRY_COUNT * 2)) seconds..."
              sleep $((RETRY_COUNT * 2))
            done
          fi
