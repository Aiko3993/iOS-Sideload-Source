name: Process App Request

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write

jobs:
  process-app:
    # Trigger if approved
    if: github.event.label.name == 'approved' && contains(github.event.issue.labels.*.name, 'app-request')
    runs-on: ubuntu-latest
    concurrency: 
      group: process-app-request
      cancel-in-progress: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests Pillow urllib3 pyyaml

      - name: Parse Issue Body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;
            
            const extract = (key) => {
              const regex = new RegExp(`### ${key}\\s+([\\s\\S]*?)(?=(###|$))`);
              const match = body.match(regex);
              return match ? match[1].trim() : null;
            };

            const apps = [];
            
            // Function to try extract app data with suffix
            const tryExtract = (suffix) => {
                const s = suffix ? ` ${suffix}` : '';
                const name = extract(`App Name${s}`);
                const repo = extract(`GitHub Repository${s}`);
                const cat = extract(`Category${s}`);
                const icon = extract(`Icon URL${s} (Optional)`);
                
                // Allow icon to be empty string if not found or placeholder
                const cleanIcon = (icon === '_No response_' || icon === 'None' || !icon) ? '' : icon;

                if (name && repo && cat && name !== '_No response_' && repo !== '_No response_' && cat !== '_No response_') {
                    apps.push({
                        name: name,
                        repo: repo,
                        category: cat,
                        icon_url: cleanIcon
                    });
                }
            };

            // Try 1, 2, 3
            tryExtract('');
            tryExtract('2');
            tryExtract('3');

            if (apps.length === 0) {
              core.setFailed('No valid app data found in issue body.');
              return;
            }

            console.log(`Found ${apps.length} apps to process.`);
            
            // Pass as JSON string
            core.setOutput('apps_json', JSON.stringify(apps));

      - name: Add or Update App
        id: add
        env:
          APPS_JSON: ${{ steps.parse.outputs.apps_json }}
        run: python3 .github/scripts/add_app.py

      - name: Generate Commit Message
        id: msg
        run: |
          # Parse the APPS_JSON again to get details for the commit message
          # This is a bit of a hack using python one-liner to extract the first app's name
          APP_NAME=$(python3 -c "import json, os; print(json.loads(os.environ['APPS_JSON'])[0]['name'])" 2>/dev/null || echo "App")
          REPO_NAME=$(python3 -c "import json, os; print(json.loads(os.environ['APPS_JSON'])[0]['repo'])" 2>/dev/null || echo "Unknown")
          
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
        env:
          APPS_JSON: ${{ steps.parse.outputs.apps_json }}

      - name: Validate Changes
        run: python3 .github/scripts/validate_apps.py

      - name: Update Source & Generate Docs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python3 .github/scripts/update_source.py

      - name: Commit and Close Issue
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add .
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes detected. Skipping commit."
          else
            git commit -m "feat: ${{ steps.add.outputs.action }} ${{ steps.msg.outputs.app_name }} (${{ steps.msg.outputs.repo_name }}) from #${{ github.event.issue.number }}"
            
            # Robust push with conflict recovery
            MAX_RETRIES=5
            RETRY_COUNT=0
            
            push_with_recovery() {
              # Try simple rebase first
              if git pull --rebase origin main && git push origin main; then
                return 0
              fi
              
              # If rebase failed (conflict), reset and try fresh approach
              echo "Rebase failed, attempting recovery..."
              git rebase --abort 2>/dev/null || true
              git reset --hard HEAD~1 2>/dev/null || true
              
              # Fetch latest and replay our changes
              git fetch origin main
              git checkout origin/main -B main
              
              # Re-run the add script (regenerate changes)
              python3 .github/scripts/add_app.py
              python3 .github/scripts/update_source.py
              
              # Commit and push
              git add .
              if ! git diff --staged --quiet; then
                git commit -m "feat: ${{ steps.add.outputs.action }} ${{ steps.msg.outputs.app_name }} (${{ steps.msg.outputs.repo_name }}) from #${{ github.event.issue.number }}"
                git push origin main
                return $?
              fi
              return 0
            }
            
            until push_with_recovery; do
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
                echo "Failed to push after $MAX_RETRIES attempts."
                exit 1
              fi
              echo "Push failed, retrying in $((RETRY_COUNT * 3)) seconds..."
              sleep $((RETRY_COUNT * 3))
            done
          fi

      - name: Comment and Close
        uses: actions/github-script@v7
        with:
          script: |
            const action = '${{ steps.add.outputs.action }}';
            let body = '';
            
            if (action === 'updated') {
               body = '✅ App details have been updated in the source list!';
            } else {
               body = '✅ Automatically added to the source list!';
            }
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
            github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed',
              state_reason: 'completed'
            });

  reject-app:
    # Trigger if rejected
    if: github.event.label.name == 'rejected' && contains(github.event.issue.labels.*.name, 'app-request') && github.event.sender.id == github.event.repository.owner.id
    runs-on: ubuntu-latest
    concurrency:
      group: process-app-request
      cancel-in-progress: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests Pillow urllib3 pyyaml

      - name: Parse Issue Body (For Removal)
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;
            const escapeRegExp = (string) => {
              return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            };
            const extract = (key) => {
              const escapedKey = escapeRegExp(key);
              const regex = new RegExp(`### ${escapedKey}\\s+([\\s\\S]*?)(?=(###|$))`);
              const match = body.match(regex);
              return match ? match[1].trim() : null;
            };
            const repo = extract('GitHub Repository');
            if (repo) {
              core.setOutput('repo', repo);
            } else {
              core.setFailed('Could not parse repo from issue body');
            }

      - name: Remove App from JSON
        id: remove
        env:
          REPO: ${{ steps.parse.outputs.repo }}
        run: python3 .github/scripts/add_app.py --remove

      - name: Update Source & Generate Docs
        if: steps.remove.outputs.removed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python3 .github/scripts/update_source.py

      - name: Commit Changes (If Removed)
        if: steps.remove.outputs.removed == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add .
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes detected. Skipping commit."
          else
            git commit -m "chore: remove app ${{ steps.parse.outputs.repo }} (rejected)"
            git pull --rebase
            git push
          fi

      - name: Close Issue (Rejected)
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed',
              state_reason: 'not_planned'
            });
            // If removed, add comment
            if ('${{ steps.remove.outputs.removed }}' === 'true') {
               github.rest.issues.createComment({
                 owner: context.repo.owner,
                 repo: context.repo.repo,
                 issue_number: context.issue.number,
                 body: '⚠️ App removed from the list because the request was rejected.'
               })
            }
